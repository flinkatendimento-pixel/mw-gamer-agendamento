<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MW Gamer ‚Ä¢ Agendamento (√önico)</title>
  <link rel="icon" href="data:," />
  <meta name="description" content="MW Gamer ‚Ä¢ Agendamento VR e PS5 com painel admin e confirma√ß√£o por WhatsApp" />
  <style>
    :root{
      --bg:#0b0d12;
      --panel:#111528;
      --card: rgba(17,21,40,.86);
      --text:#e9ecf3;
      --muted:#9aa4ba;
      --border:rgba(255,255,255,.10);
      --brand:#00ff9c;
      --brand2:#00c2ff;
      --danger:#ff5c7a;
      --ok:#52ffb8;
      --warn:#ffd166;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 650px at 15% 0%, rgba(0,255,156,.10), transparent 55%),
        radial-gradient(1000px 700px at 90% 10%, rgba(0,194,255,.09), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(12px);
      background: rgba(11,13,18,.75);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:1180px; margin:0 auto; padding:14px 16px}
    .top{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .brand{display:flex; align-items:center; gap:12px; min-width: 240px}
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 18px 50px rgba(0,255,156,.12);
      flex: 0 0 auto;
    }
    h1{margin:0; font-size:15px; letter-spacing:.4px}
    .sub{font-size:12px; color:var(--muted)}
    .actions{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    button, input, select, textarea{
      font:inherit; color:var(--text);
      background: rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
    }
    select option{color:#000; background:#fff;}
    button{
      cursor:pointer;
      transition: .15s transform, .15s border-color, .15s background;
      user-select:none;
    }
    button:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.18)}
    button.primary{
      background: linear-gradient(135deg, rgba(0,255,156,.14), rgba(0,194,255,.12));
      border-color: rgba(0,255,156,.28);
      font-weight:900;
    }
    button.danger{
      background: rgba(255,92,122,.08);
      border-color: rgba(255,92,122,.35);
    }
    button.ghost{background: transparent}
    button.small{padding:8px 10px; font-size:12px; border-radius:10px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .pill.ok{border-color: rgba(82,255,184,.22); background: rgba(82,255,184,.06); color: rgba(82,255,184,.9);}
    .pill.warn{border-color: rgba(255,209,102,.25); background: rgba(255,209,102,.06); color: rgba(255,209,102,.95);}
    main{max-width:1180px; margin:0 auto; padding:16px}
    .card{
      background: rgba(17,21,40,.74);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap;
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);
    }
    .cardHead h2{margin:0; font-size:14px}
    .cardBody{padding:14px}
    .grid{display:grid; grid-template-columns: 1fr 420px; gap:16px; align-items:start}
    @media (max-width: 1020px){ .grid{grid-template-columns:1fr} }
    .row{display:grid; gap:10px}
    .row.two{grid-template-columns:1fr 1fr}
    .row.three{grid-template-columns:1fr 1fr 1fr}
    @media (max-width: 520px){ .row.two,.row.three{grid-template-columns:1fr} }
    label{display:block; margin:0 0 6px; font-size:12px; color:var(--muted)}
    .divider{height:1px; background: var(--border); margin:12px 0}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .muted{color:var(--muted)}
    .kpi{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}

    /* Client experience toggles */
    .seg{display:grid; grid-template-columns: repeat(2, 1fr); gap:10px}
    .seg3{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px}
    @media (max-width: 420px){ .seg3{grid-template-columns: repeat(2, 1fr)} }

    /* Slots */
    .slots{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px}
    @media (max-width: 1020px){ .slots{grid-template-columns: repeat(3, 1fr)} }
    @media (max-width: 760px){ .slots{grid-template-columns: repeat(2, 1fr)} }
    @media (max-width: 520px){ .slots{grid-template-columns: 1fr} }
    .slot{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background: rgba(255,255,255,.02);
      display:flex; flex-direction:column; gap:8px;
      min-height:92px;
    }
    .slot{cursor:pointer; transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease, background .12s ease}
    .slot:hover{transform: translateY(-1px); border-color: rgba(34,211,238,.45)}
    /* Slot selecionado */
    .slot.active{
      border-color: rgba(34,211,238,.85);
      background: rgba(34,211,238,.08);
      box-shadow: 0 0 0 3px rgba(34,211,238,.10);
    }
    .slot.active .badge{
      border-color: rgba(34,211,238,.55);
      color:#bff7ff;
    }
    .slotTop{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .time{font-weight:800; letter-spacing:.4px}
    .badge{
      font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid var(--border);
      color:var(--muted); background: rgba(255,255,255,.03);
      white-space:nowrap;
    }
    .badge.ok{border-color: rgba(82,255,184,.28); color: rgba(82,255,184,.92); background: rgba(82,255,184,.06)}
    .badge.busy{border-color: rgba(255,92,122,.35); color: rgba(255,92,122,.92); background: rgba(255,92,122,.06)}
    .badge.block{border-color: rgba(255,255,255,.20); color: rgba(233,236,243,.90); background: rgba(255,255,255,.04)}
    .meta{font-size:12px; color:var(--muted); line-height:1.35}
    .slotBtns{display:flex; gap:8px; flex-wrap:wrap}
    .slotBtns button{flex: 1 1 auto}

    /* List */
    .list{display:flex; flex-direction:column; gap:10px}
    .item{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background: rgba(255,255,255,.02);
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .itemMain{min-width: 260px}
    .itemTitle{font-weight:800}
    .itemSmall{font-size:12px; color:var(--muted); margin-top:6px; line-height:1.35}
    .itemBtns{display:flex; gap:8px; flex-wrap:wrap; align-items:flex-start}
    .tag{
      font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      display:inline-flex; gap:6px; align-items:center;
    }
    .tag.paid{border-color: rgba(82,255,184,.28); color: rgba(82,255,184,.92); background: rgba(82,255,184,.06)}
    .tag.pending{border-color: rgba(255,209,102,.30); color: rgba(255,209,102,.95); background: rgba(255,209,102,.06)}
    .tag.block{border-color: rgba(255,255,255,.18); color: rgba(233,236,243,.88); background: rgba(255,255,255,.04)}

    /* Modal */
    .modalOverlay{
      position:fixed; inset:0; z-index:50;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
    }
    .modal{
      width:min(720px, 100%);
      background: rgba(17,21,40,.92);
      border:1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap;
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);
    }
    .modalHead h3{margin:0; font-size:14px}
    .modalBody{padding:14px}
    .modalFoot{
      padding:12px 14px;
      border-top:1px solid var(--border);
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
    }
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:16px; z-index:60;
      background: rgba(17,21,40,.92);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      font-size:13px;
      max-width:min(560px, calc(100% - 24px));
      display:none;
    }

    /* Admin lock screen */
    .lockOverlay{
      position:fixed; inset:0; z-index:9999;
      background: radial-gradient(900px 650px at 15% 0%, rgba(0,255,156,.12), transparent 55%),
                  radial-gradient(1000px 700px at 90% 10%, rgba(0,194,255,.10), transparent 60%),
                  rgba(7,9,17,.96);
      display:none; align-items:center; justify-content:center;
      padding:16px;
    }
    .lockCard{
      width:min(520px, 100%);
      background: rgba(17,21,40,.92);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .lockHead{padding:14px; border-bottom:1px solid var(--border)}
    .lockHead h2{margin:0; font-size:14px}
    .lockBody{padding:14px}
    .lockActions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; padding:12px 14px; border-top:1px solid var(--border)}
    .lockHint{font-size:12px; color:var(--muted); line-height:1.4; margin-top:8px}

    /* Views */
    .hide{display:none !important;}
    .appHidden{filter: blur(2px); pointer-events:none; user-select:none;}
    .noticeBox{font-size:12px; color:var(--muted); line-height:1.45}
    .noticeBox b{color:var(--text)}
  
/* === FIX: estados "active" (selecionado) nos bot√µes do cliente === */
button.active,
.seg3 button.active,
.seg2 button.active{
  border-color: rgba(0,194,255,.85) !important;
  background: rgba(0,194,255,.14) !important;
  box-shadow: 0 0 0 2px rgba(0,194,255,.12), 0 10px 22px rgba(0,0,0,.35);
  color: var(--text) !important;
}
button:focus-visible{outline:2px solid rgba(0,194,255,.85); outline-offset:2px}

/* Deixa o √≠cone do calend√°rio vis√≠vel em tema escuro */
input[type="date"]::-webkit-calendar-picker-indicator{
  filter: invert(1) brightness(1.3);
  opacity: .9;
  cursor: pointer;
}
input[type="date"]::-webkit-datetime-edit,
input[type="date"]::-webkit-datetime-edit-text,
input[type="date"]::-webkit-datetime-edit-month-field,
input[type="date"]::-webkit-datetime-edit-day-field,
input[type="date"]::-webkit-datetime-edit-year-field{
  color: var(--text);
}

</style>
</head>
<body>

<header>
  <div class="wrap top">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div class="title">
        <h1>MW Gamer ‚Ä¢ Agendamento</h1>
        <div class="sub" id="headerSub">VR (Meta Quest) por pessoa ‚Ä¢ PS5 ‚Ä¢ Po√ßos de Caldas</div>
      </div>
    </div>

    <div class="actions">
      <span class="pill" id="modePill">Modo: ‚Äî</span>
      <button class="ghost small" id="goClientBtn" type="button">Cliente</button>
      <button class="ghost small" id="goAdminBtn" type="button">Admin</button>
      <button class="ghost small hide" id="logoutBtn" type="button">Sair</button>
    </div>
  </div>
</header>

<!-- ADMIN LOCK -->
<div class="lockOverlay" id="lockOverlay">
  <div class="lockCard">
    <div class="lockHead">
      <h2>MW Gamer ‚Ä¢ Administra√ß√£o</h2>
      <div class="sub">Acesso restrito</div>
    </div>
    <div class="lockBody">
      <label style="display:block; font-size:12px; color:var(--muted); margin:0 0 6px">Digite seu PIN</label>
      <input id="pinInput" inputmode="numeric" autocomplete="one-time-code" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      
      <label style="display:block; font-size:12px; color:var(--muted); margin:12px 0 6px">Senha Admin (para confirmar/excluir)</label>
      <input id="adminPassInput" type="password" autocomplete="current-password" placeholder="Sua senha (n√£o fica salva)" />
<div class="lockHint">
        Dica: se esquecer o PIN, edite este arquivo e troque o valor em <b>ADMIN_PIN</b>.
      </div>
      <div class="divider"></div>
      <div class="noticeBox">
        <b>Importante:</b> para o sistema funcionar ‚Äúonline‚Äù e sincronizado entre celulares/PCs, este arquivo usa <b>Supabase</b> como banco.
        Preencha <b>SUPABASE_URL</b> e <b>SUPABASE_ANON_KEY</b> no topo do script.
      </div>
    </div>
    <div class="lockActions">
      <button type="button" class="ghost" id="openClientFromLockBtn">Abrir p√°gina do cliente</button>
      <button type="button" class="primary" id="unlockBtn">Entrar</button>
    </div>
  </div>
</div>

<main>
  <!-- CLIENT VIEW -->
  <section class="card" id="clientView">
    <div class="cardHead">
      <div>
        <h2>Agendamento r√°pido</h2>
        <div class="sub">Escolha o hor√°rio e envie no WhatsApp. Confirma√ß√£o pela equipe.</div>
        <div class="kpi">
          <span class="pill"><b>Endere√ßo:</b> R. Esp√≠rito Santo, 25 - Centro, Po√ßos de Caldas - MG</span>
        </div>
      </div>
      <div class="toolbar">
        <span class="pill warn">Domingos fechados</span>
        <span class="pill warn">Almo√ßo 12:00‚Äì13:00</span>
        <span class="pill ok">Funcionamento 10:00‚Äì21:00</span>
      </div>
    </div>
    <div class="cardBody">
      <div class="row">
        <label>Experi√™ncia</label>
        <div class="seg">
          <button type="button" id="c_btnVR" class="active">VR (Meta Quest 3)</button>
          <button type="button" id="c_btnPS5">PS5</button>
        </div>
        <div class="kpi" id="c_priceHint"></div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <label>Tempo</label>
        <div class="seg">
          <button type="button" id="c_btn30" class="active">30 minutos</button>
          <button type="button" id="c_btn60">60 minutos</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <label>Pessoas</label>
        <div class="seg3" id="c_peopleBtns"></div>
        <div class="muted" id="c_peopleHint" style="margin-top:8px"></div>
      </div>

      <div class="divider"></div>

      <div class="row two">
        <div>
          <label>Dia</label>
          <input type="date" id="c_date" style="cursor:pointer" />
          <div class="muted" style="margin-top:8px">Se escolher domingo, ajustaremos para a pr√≥xima segunda.</div>
        </div>
        <div>
          <label>Seu nome</label>
          <input id="c_name" placeholder="Ex: Jo√£o" />
        </div>
      </div>

      <div class="row two" style="margin-top:10px">
        <div>
          <label>WhatsApp (opcional)</label>
          <input id="c_phone" placeholder="Ex: (35) 9XXXX-XXXX" inputmode="tel" />
        </div>
        <div>
          <label>Observa√ß√£o (opcional)</label>
          <input id="c_notes" placeholder="Ex: VR multiplayer, chegaremos 10 min antes..." />
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <label>Hor√°rio</label>
        <div class="muted">Selecione um hor√°rio dispon√≠vel (os lotados somem/ficam bloqueados).</div>
        <div class="slots" id="c_slots"></div>
        <button type="button" id="c_moreBtn" class="ghost small" style="margin-top:10px; display:none">Ver mais</button>
      </div>

      <div class="divider"></div>

      <div class="toolbar" style="justify-content:space-between">
        <span class="pill ok"><b>Total:</b> R$ <span id="c_total">‚Äî</span></span>
        <button type="button" class="primary" id="c_sendBtn">Enviar no WhatsApp</button>
      </div>

      <div class="divider"></div>
      <div class="noticeBox">
        <b>Como funciona:</b> ao enviar, seu pedido entra como <b>PENDENTE</b> na agenda.
        A equipe confirma o pagamento e marca como <b>PAGO</b>. Depois disso, o hor√°rio fica bloqueado para novos pedidos (respeitando capacidade).
      </div>
    </div>
  </section>

  <!-- ADMIN VIEW -->
  <section class="hide" id="adminView">
    <div class="grid">
      <section class="card">
        <div class="cardHead">
          <div>
            <h2>Painel de agendamentos</h2>
            <div class="sub" id="a_dayLabel">‚Äî</div>
            <div class="sub" id="a_dayNotice" style="margin-top:4px"></div>
          </div>
          <div class="toolbar">
            <button class="ghost small" id="a_prevDayBtn" type="button">‚óÄ Dia</button>
            <button class="ghost small" id="a_nextDayBtn" type="button">Dia ‚ñ∂</button>
            <button class="primary small" id="a_newBtn" type="button">+ Novo</button>
            <button class="danger small" id="a_resetBtn" type="button">Zerar</button>
          </div>
        </div>

        <div class="cardBody">
          <div class="row two">
            <div>
              <label>Data</label>
              <input type="date" id="a_date" />
            </div>
            <div>
              <label>Filtro</label>
              <select id="a_filterType">
                <option value="ALL" selected>Todos</option>
                <option value="VR">VR</option>
                <option value="PS5">PS5</option>
                <option value="BLOQUEIO">Bloqueio</option>
                <option value="PENDENTE">Pendentes</option>
                <option value="PAGO">Pagos</option>
              </select>
            </div>
          </div>

          <div class="row two" style="margin-top:10px">
            <div>
              <label>Buscar (nome/telefone)</label>
              <input id="a_search" placeholder="Ex: Jo√£o / (35) 9..." />
            </div>
            <div>
              <label>Exibi√ß√£o</label>
              <select id="a_viewMode">
                <option value="SLOTS" selected>Hor√°rios</option>
                <option value="LIST">Lista</option>
              </select>
            </div>
          </div>

          <div class="kpi" id="a_kpis"></div>

          <div class="divider"></div>

          <div id="a_slotsWrap">
            <div class="slots" id="a_slots"></div>
          </div>

          <div id="a_listWrap" style="display:none">
            <div class="list" id="a_list"></div>
          </div>
        </div>
      </section>

      <aside class="card">
        <div class="cardHead">
          <div>
            <h2>Opera√ß√£o</h2>
            <div class="sub">Notifica√ß√µes e atalhos</div>
          </div>
        </div>
        <div class="cardBody">
          <div class="row">
            <div class="pill" id="a_openHoursPill"><span class="muted">Das</span> <b id="a_openHours">‚Äî</b></div>
            <div class="pill"><b>Capacidade</b> VR <span id="a_capVr">‚Äî</span> ‚Ä¢ PS5 <span id="a_capPs5">‚Äî</span></div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <button class="ghost" id="a_downloadCsvBtn" type="button">Baixar lista do dia (CSV)</button>
            <button class="ghost" id="a_copyWppPreviewBtn" type="button">Copiar mensagem WhatsApp (modelo)</button>
          </div>

          <div id="a_quickPend" class="noticeBox" style="margin-top:10px"></div>

          <div class="divider"></div>

          <div class="row">
            <div class="noticeBox">
              <b>Notifica√ß√£o:</b> quando entrar pedido novo, ele aparece como <b>PENDENTE</b> e o navegador faz um aviso (toast) + contagem em ‚ÄúPendentes‚Äù.
              <div class="divider"></div>
              <b>Dica:</b> para confirmar, clique em <b>WhatsApp</b> ‚Üí abre conversa ‚Üí ao receber o pagamento, clique em <b>Marcar pago</b>.
            </div>
          </div>

          <div class="divider"></div>
          <div class="noticeBox">
            <b>Seguran√ßa:</b> este arquivo usa ‚ÄúPIN‚Äù apenas para esconder o painel no navegador.
            Em produ√ß√£o, voc√™ deve ativar <b>RLS</b> no Supabase e permitir que s√≥ voc√™ confirme/exclua (veja instru√ß√µes no final do arquivo).
          </div>
        </div>
      </aside>
    </div>
  </section>
</main>

<!-- MODAL (ADMIN CRUD) -->
<div class="modalOverlay" id="modalOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modalHead">
      <div>
        <h3 id="modalTitle">Novo agendamento</h3>
        <div class="sub" id="modalSubtitle">‚Äî</div>
      </div>
      <div class="toolbar">
        <button class="ghost small" id="closeModalBtn" type="button">Fechar</button>
      </div>
    </div>

    <div class="modalBody">
      <div class="row two">
        <div>
          <label>Data</label>
          <input type="date" id="m_date" />
        </div>
        <div>
          <label>Hor√°rio (in√≠cio)</label>
          <input type="time" id="m_start" value="10:00" />
        </div>
      </div>

      <div class="row two" style="margin-top:10px">
        <div>
          <label>Dura√ß√£o</label>
          <select id="m_duration">
            <option value="30" selected>30 min</option>
            <option value="60">60 min</option>
          </select>
        </div>
        <div>
          <label>Tipo</label>
          <select id="m_type">
            <option value="VR" selected>VR</option>
            <option value="PS5">PS5</option>
            <option value="BLOQUEIO">Bloqueio</option>
          </select>
        </div>
      </div>

      <div class="row two" style="margin-top:10px">
        <div>
          <label>Pessoas</label>
          <select id="m_qty"></select>
        </div>
        <div>
          <label>Status</label>
          <select id="m_status">
            <option value="PENDENTE" selected>Pendente</option>
            <option value="PAGO">Pago</option>
          </select>
        </div>
      </div>

      <div class="row two" style="margin-top:10px">
        <div>
          <label>Nome (ou motivo do bloqueio)</label>
          <input id="m_name" placeholder="Ex: Jo√£o" />
        </div>
        <div>
          <label>WhatsApp</label>
          <input id="m_phone" placeholder="Ex: (35) 9XXXX-XXXX" inputmode="tel" />
        </div>
      </div>

      <div class="row two" style="margin-top:10px">
        <div>
          <label>Valor</label>
          <input id="m_price" placeholder="Autom√°tico (VR/PS5)" inputmode="numeric" />
        </div>
        <div>
          <label>Observa√ß√µes</label>
          <input id="m_notes" placeholder="Ex: chegar 10 min antes..." />
        </div>
      </div>

      <div class="kpi" id="modalKpis"></div>
    </div>

    <div class="modalFoot">
      <button class="danger" id="deleteBtn" type="button" style="display:none">Excluir</button>
      <button class="ghost" id="copyWppBtn" type="button">Copiar WhatsApp</button>
      <button class="ghost" id="openWppBtn" type="button">Abrir WhatsApp</button>
      <button class="primary" id="markPaidBtn" type="button" style="display:none">Marcar pago</button>
      <button class="primary" id="saveBtn" type="button">Salvar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Supabase client (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
(() => {
  // ==========================================================
  // ‚úÖ CONFIGURAR AQUI (OBRIGAT√ìRIO PARA FUNCIONAR ONLINE)
  // ==========================================================
  const SUPABASE_URL = "https://vnpxxjvyapnexexdijch.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_ek6zzE9-Z3Dqo-Ea3m9W8g_gHxwye8s";

  // Helper: minutes (0-1439) -> 'HH:MM'
  function minToHHMM(min){
    if(min === null || min === undefined) return '';
    const n = Number(min);
    if(Number.isNaN(n)) return '';
    const h = Math.floor(n/60);
    const m = Math.round(n - h*60);
    return String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0');
  }

  

  // ==========================================================
  // ‚úÖ (RECOMENDADO) EDGE FUNCTION (SEGURAN√áA DO ADMIN)
  // Crie uma Edge Function no Supabase e cole a URL abaixo.
  // Ex: https://SEU-PROJETO.supabase.co/functions/v1/mw-admin
  // ==========================================================
  const ADMIN_FUNCTION_URL = "COLE_A_URL_DA_EDGE_FUNCTION_AQUI";
// ==========================================================
  // SUA CONFIG (MW Gamer)
  // ==========================================================
  const CONFIG = {
    CAPACITY: { VR: 6, PS5: 2 }, // PS5 = consoles
    PRICING: {
      VR: { "30": 20, "60": 35 }, // por pessoa
      PS5: {
        "30": { onePerson: 15, twoPeople: 20 }, // 1 console
        "60": { onePerson: 30, twoPeople: 40 }  // 1 console
      }
    },
    SLOT_MINUTES: 30,
    DAY_START: 10,
    DAY_END: 21, // √∫ltimo slot 20:30
    CLOSED_WEEKDAYS: [0], // 0=Domingo
    LUNCH_BREAKS: [{ start: "12:00", end: "13:00" }],
    ADDRESS_LINE: "Endere√ßo: R. Esp√≠rito Santo, 25 - Centro, Po√ßos de Caldas - MG, 37701-037",
    RULE_LINE: "Chegar 10 min antes. Atrasos podem reduzir o tempo para manter a agenda.",
    WHATSAPP_NUMBER_E164: "5535999030721",
  };

  // ==========================================================
  // ADMIN PIN (APENAS VISUAL NO NAVEGADOR)
  // ==========================================================
  const ADMIN_PIN = "839214";
  const ADMIN_TOKEN_KEY = "mw_admin_unlocked_v2";

  
  const ADMIN_PASS_SESSION_KEY = "mw_admin_pass_set_v1"; // s√≥ para lembrar que voc√™ j√° digitou nesta aba
  let adminPass = ""; // digitada no lock (n√£o fica no arquivo)

  async function adminApi(action, payload){
  // Se voc√™ N√ÉO configurou Edge Function, usamos acesso direto ao banco (funciona com RLS liberado).
  if(!ADMIN_FUNCTION_URL || ADMIN_FUNCTION_URL.startsWith("COLE_")){
    if(action==="set_status"){
      const { id, status } = payload||{};
      const patch = { status };
      if(status==="PAGO") patch.admin_confirmed_at = new Date().toISOString();
      const { error } = await ensureSupabase().from(TABLE).update(patch).eq("id", id);
      if(error) throw error;
      return { ok:true, fallback:true };
    }
    if(action==="delete"){
      const { id } = payload||{};
      const { error } = await ensureSupabase().from(TABLE).delete().eq("id", id);
      if(error) throw error;
      return { ok:true, fallback:true };
    }
    if(action==="upsert"){
      const { booking } = payload||{};
      const { error } = await ensureSupabase().from(TABLE).upsert(booking);
      if(error) throw error;
      return { ok:true, fallback:true };
    }
    // Outras a√ß√µes (reset_all etc.) - sem Edge Function, tentamos via Supabase direto.
// OBS: para isso funcionar em produ√ß√£o, crie policy DELETE para anon em public.mw_bookings.
if(action === "reset_all"){
  const targetDate = (payload && payload.date) ? payload.date : (document.getElementById('a_date')?.value || isoToday());
  if(!targetDate) throw new Error("Data inv√°lida para zerar.");
  const { error } = await ensureSupabase().from(TABLE).delete().eq("date", targetDate);
  if(error) throw error;
  return { ok:true, mode:"supabase" };
}
throw new Error("ADMIN_FUNCTION_URL n√£o configurada para esta a√ß√£o: " + action);
}
    if(!adminPass){
      // tenta pegar da sess√£o
      adminPass = sessionStorage.getItem(ADMIN_PASS_SESSION_KEY) || "";
    }
    if(!adminPass){
      throw new Error("Senha Admin n√£o informada.");
    }
    const res = await fetch(ADMIN_FUNCTION_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-mw-admin-pass": adminPass
      },
      body: JSON.stringify({ action, payload })
    });
    const json = await res.json().catch(()=> ({}));
    if(!res.ok || json?.error){
      const msg = json?.error || `Erro admin (${res.status})`;
      throw new Error(msg);
    }
    return json?.data ?? json;
  }
// ==========================================================
  // DB (Supabase) ‚Äì TABELA ESPERADA: mw_bookings
  // ==========================================================
  // Campos recomendados:
  // id (uuid) PK default gen_random_uuid()
  // created_at timestamptz default now()
  // date (date) NOT NULL
  // start_min int NOT NULL
  // end_min int NOT NULL
  // type text NOT NULL  ('VR'|'PS5'|'BLOQUEIO')
  // qty int NOT NULL default 0
  // status text NOT NULL default 'PENDENTE' ('PENDENTE'|'PAGO')
  // name text
  // phone text
  // price int
  // notes text
  // source text default 'client' ('client'|'admin')
  // admin_confirmed_at timestamptz
  //
  // √çndices √∫teis: (date), (date, start_min), (status)
  //
  // ‚ö†Ô∏è Para reduzir ‚Äúcorrida‚Äù de dois clientes no mesmo minuto:
  // - o ideal √© criar uma fun√ß√£o (RPC) que checa capacidade e insere de forma at√¥mica.
  // Aqui n√≥s fazemos checagem no cliente e tentamos inserir; na pr√°tica funciona bem para loja pequena.
  //
  // ==========================================================
  const TABLE = "mw_bookings";

  // ==========================================================
  // HELPERS
  // ==========================================================
  const $ = (id) => document.getElementById(id);
  const pad2 = (n) => String(n).padStart(2,"0");
  
  const esc = (s="") => String(s).replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const minToTime = (m) => `${pad2(Math.floor(m/60))}:${pad2(m%60)}`;
  const timeToMin = (t) => { const [hh, mm] = t.split(":").map(Number); return hh*60 + mm; };
  const overlaps = (aStart, aEnd, bStart, bEnd) => aStart < bEnd && bStart < aEnd;

  function toast(msg){
    const el = $("toast");
    el.textContent = msg;
    el.style.display = "block";
    clearTimeout(toast._t);
    toast._t = setTimeout(()=> el.style.display="none", 2800);
  }

  function todayISO(){
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }
  function formatBR(iso){
    const [y,m,d] = iso.split("-").map(Number);
    return `${pad2(d)}/${pad2(m)}/${y}`;
  }
  function isPastDate(dateStr){
    const [y,m,d] = dateStr.split("-").map(Number);
    const date = new Date(y,m-1,d,0,0,0,0);
    const [ty,tm,td] = todayISO().split("-").map(Number);
    const today = new Date(ty,tm-1,td,0,0,0,0);
    return date < today;
  }
  function isClosedWeekday(dateStr){
    const [y,m,d] = dateStr.split("-").map(Number);
    const dt = new Date(y,m-1,d);
    return (CONFIG.CLOSED_WEEKDAYS||[]).includes(dt.getDay());
  }
  function inLunchBreak(startMin,endMin){
    for(const br of (CONFIG.LUNCH_BREAKS||[])){
      const bStart = timeToMin(br.start);
      const bEnd = timeToMin(br.end);
      if(overlaps(startMin,endMin,bStart,bEnd)) return true;
    }
    return false;
  }
  function normalizePhone(v){
    const digits = (v || "").replace(/\D/g,"").slice(0,11);
    if(digits.length <= 2) return digits;
    if(digits.length <= 7) return `(${digits.slice(0,2)}) ${digits.slice(2)}`;
    const dd = digits.slice(0,2);
    const a = digits.slice(2,7);
    const b = digits.slice(7);
    return `(${dd}) ${a}${b ? "-" + b : ""}`;
  }
  function parsePrice(v){
    if(!v) return "";
    const digits = String(v).replace(/[^\d]/g,"");
    if(!digits) return "";
    return String(Number(digits));
  }
  function humanType(t){ return t === "BLOQUEIO" ? "Bloqueio" : t; }

  function suggestedTotal(type, durationMin, people){
    const d = String(durationMin);
    const qty = Number(people || 0);
    if(qty <= 0) return "";
    if(type === "VR"){
      const unit = CONFIG.PRICING?.VR?.[d];
      return unit ? String(unit * qty) : "";
    }
    if(type === "PS5"){
      const rule = CONFIG.PRICING?.PS5?.[d];
      if(!rule) return "";
      if(qty === 1) return String(rule.onePerson);
      if(qty === 2) return String(rule.twoPeople);
      return "";
    }
    return "";
  }

  function buildWppMsg(b){
    const start = minToTime(b.start_min);
    const end = minToTime(b.end_min);
    const date = formatBR(b.date);
    const type = humanType(b.type);

    const lines = [];
    lines.push(`MW Gamer ‚Ä¢ Confirma√ß√£o de Agendamento`);
    lines.push(`Data: ${date}`);
    lines.push(`Hor√°rio: ${start}‚Äì${end}`);

    if(b.type === "BLOQUEIO"){
      lines.push(`Tipo: ${type}`);
      if(b.name) lines.push(`Motivo: ${b.name}`);
    } else if(b.type === "VR"){
      lines.push(`Tipo: VR ‚Ä¢ Pessoas: ${b.qty}`);
      if(b.name) lines.push(`Nome: ${b.name}`);
    } else if(b.type === "PS5"){
      lines.push(`Tipo: PS5 ‚Ä¢ Pessoas: ${b.qty} (1 console)`);
      if(b.name) lines.push(`Nome: ${b.name}`);
    }

    if(b.phone) lines.push(`WhatsApp: ${b.phone}`);
    if(b.price) lines.push(`Valor: R$ ${b.price}`);
    if(b.status && b.type !== "BLOQUEIO") lines.push(`Status: ${b.status}`);
    if(b.notes) lines.push(`Obs: ${b.notes}`);
    lines.push(CONFIG.ADDRESS_LINE);
    lines.push(CONFIG.RULE_LINE);
    return lines.join("\n");
  }

  function buildWppUrlE164(targetE164, text){
    const enc = encodeURIComponent(text);
    return `https://wa.me/${targetE164}?text=${enc}`;
  }

  function phoneToE164Br(phonePretty){
    // aceita "(35) 9xxxx-xxxx" etc e tenta virar "55359...."
    const digits = String(phonePretty||"").replace(/\D/g,"");
    if(!digits) return "";
    // se entender que j√° tem DDI 55:
    if(digits.startsWith("55") && digits.length >= 12) return digits;
    // assume BR
    if(digits.length >= 10) return "55" + digits;
    return ""; // insuficiente
  }

  // ==========================================================
  // SUPABASE INIT
  // ==========================================================
  let sb = null;
  function ensureSupabase(){
    if(sb) return sb;
    if(!SUPABASE_URL || SUPABASE_URL.includes("COLE_") || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.includes("COLE_")){
      throw new Error("Supabase n√£o configurado. Preencha SUPABASE_URL e SUPABASE_ANON_KEY.");
    }
    sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    return sb;
  }

  // ==========================================================
  // ROUTER (1 arquivo: #cliente ou #admin)
  // ==========================================================
  function setMode(mode){
    const isAdmin = mode === "admin";
    $("clientView").classList.toggle("hide", isAdmin);
    $("adminView").classList.toggle("hide", !isAdmin);
    $("logoutBtn").classList.toggle("hide", !isAdmin);
    $("modePill").textContent = `Modo: ${isAdmin ? "Admin" : "Cliente"}`;
    $("headerSub").textContent = isAdmin ? "Administra√ß√£o ‚Ä¢ Confirma√ß√£o e capacidade" : "VR (Meta Quest) por pessoa ‚Ä¢ PS5 ‚Ä¢ Po√ßos de Caldas";
  }
  function goto(mode){
    location.hash = mode === "admin" ? "#admin" : "#cliente";
  }
  function currentMode(){
    return (location.hash || "#cliente").replace("#","") === "admin" ? "admin" : "cliente";
  }

  // ==========================================================
  // ADMIN LOCK (PIN)
  // ==========================================================
  function isUnlocked(){ return localStorage.getItem(ADMIN_TOKEN_KEY) === "1"; }
  function lockAdmin(){
    localStorage.removeItem(ADMIN_TOKEN_KEY);
    $("lockOverlay").style.display = "flex";
    $("adminView").classList.add("appHidden");
  }
  function unlockAdmin(){
    localStorage.setItem(ADMIN_TOKEN_KEY, "1");
    $("lockOverlay").style.display = "none";
    $("adminView").classList.remove("appHidden");
  }

  // ==========================================================
  // SHARED DATA (cache)
  // ==========================================================
  const cache = {
    dayBookings: new Map(), // key: yyyy-mm-dd -> array
    lastSeenInsertAt: null,
  };

  async function fetchDay(dateISO){
    const client = ensureSupabase();
    const { data, error } = await client
      .from(TABLE)
      .select("*")
      .eq("date", dateISO)
      .order("start_min", { ascending: true });

    if(error) throw error;
    cache.dayBookings.set(dateISO, data || []);
    return data || [];
  }

  function getCachedDay(dateISO){
    return cache.dayBookings.get(dateISO) || [];
  }

  function capacityUsed(bookings, type, startMin, endMin, ignoreId=null){
    let used = 0;
    for(const b of bookings){
      if(ignoreId && b.id === ignoreId) continue;
      if(b.type !== type) continue;
      if(overlaps(startMin, endMin, b.start_min, b.end_min)){
        if(type === "VR") used += (Number(b.qty) || 0);
        if(type === "PS5") used += 1; // 1 console por agendamento
      }
    }
    return used;
  }

  function hasBlock(bookings, startMin, endMin, ignoreId=null){
    return bookings.some(b => b.type === "BLOQUEIO" && (!ignoreId || b.id !== ignoreId) && overlaps(startMin,endMin,b.start_min,b.end_min));
  }

  function canCreateOrUpdate(bookings, b){
    if(b.type !== "BLOQUEIO"){
      if(hasBlock(bookings, b.start_min, b.end_min, b.id || null)){
        return { ok:false, reason:"Entretanto existe um bloqueio nesse per√≠odo." };
      }
      const cap = CONFIG.CAPACITY[b.type];
      const used = capacityUsed(bookings, b.type, b.start_min, b.end_min, b.id || null);
      const after = used + (b.type === "PS5" ? 1 : (Number(b.qty)||0));
      if(after > cap){
        return { ok:false, reason:`Capacidade excedida para ${b.type}. Usado: ${used}/${cap}.` };
      }
    }
    return { ok:true };
  }

  // ==========================================================
  // CLIENT VIEW LOGIC
  // ==========================================================
  const cState = { type:"VR", duration:30, people:1, date:"", startMin:null, showAllSlots:true };

  function cPriceHint(){
    if(cState.type === "VR"){
      return `VR por pessoa: 30 min = R$ ${CONFIG.PRICING.VR["30"]} ‚Ä¢ 60 min = R$ ${CONFIG.PRICING.VR["60"]}`;
    }
    return `PS5 (1 console): 1 pessoa: 30 min = R$ ${CONFIG.PRICING.PS5["30"].onePerson} ‚Ä¢ 60 min = R$ ${CONFIG.PRICING.PS5["60"].onePerson} | 2 pessoas: 30 min = R$ ${CONFIG.PRICING.PS5["30"].twoPeople} ‚Ä¢ 60 min = R$ ${CONFIG.PRICING.PS5["60"].twoPeople}`;
  }

  function cSetActive(btns, activeId){ btns.forEach(b => b.classList.toggle("active", b.id === activeId)); }

  function cRenderPeopleButtons(){
    const el = $("c_peopleBtns");
    el.innerHTML = "";
    const max = cState.type === "VR" ? 6 : 2;
    for(let p=1; p<=max; p++){
      const b = document.createElement("button");
      b.type = "button";
      b.textContent = String(p);
      b.className = (p === cState.people) ? "active" : "";
      b.addEventListener("click", ()=>{
        cState.people = p;
        $("c_total").textContent = suggestedTotal(cState.type, cState.duration, cState.people) || "‚Äî";
        cRenderPeopleButtons();
        cBuildSlots(); // pode mudar capacidade efetiva? (VR sim)
      });
      el.appendChild(b);
    }
    $("c_peopleHint").textContent = cState.type === "VR"
      ? "VR: 1 a 6 pessoas."
      : "PS5: at√© 2 pessoas (1 console). Para 3+ pessoas, fa√ßa 2 pedidos separados.";
  }

  function cValidate(){
    const name = $("c_name").value.trim();
    if(!name) return "Informe seu nome.";
    if(!cState.date) return "Selecione o dia.";
    if(isPastDate(cState.date)) return "N√£o √© poss√≠vel agendar em dias anteriores ao dia atual.";
    if(isClosedWeekday(cState.date)) return "Domingo: a MW Gamer est√° fechada.";
    if(cState.startMin === null) return "Selecione um hor√°rio.";
    return null;
  }

  async function cBuildSlots(){
    const slotsEl = $("c_slots");
    slotsEl.innerHTML = "";
    cState.startMin = null;

    const date = cState.date;
    if(!date) return;

    if(isClosedWeekday(date)){
      slotsEl.innerHTML = `<span class="pill warn"><b>Domingo</b> ‚Ä¢ Fechado</span>`;
      return;
    }

    // carregar do banco (sempre)
    let bookings = [];
    try{
      bookings = await fetchDay(date);
    }catch(e){
      toast("Configure o Supabase para ativar agenda online.");
      return;
    }

    const openStart = timeToMin("10:00");
    const openEnd = timeToMin("21:00");
    const duration = cState.duration;

    const all = [];
    for(let t=openStart; t<openEnd; t+=CONFIG.SLOT_MINUTES){
      const startMin = t;
      const endMin = startMin + duration;
      if(endMin > openEnd) continue;
      if(inLunchBreak(startMin, endMin)) continue;

      // disponibilidade respeitando capacidade e bloqueios
      if(hasBlock(bookings, startMin, endMin)) continue;

      if(cState.type === "VR"){
        const used = capacityUsed(bookings, "VR", startMin, endMin);
        const after = used + cState.people;
        if(after > CONFIG.CAPACITY.VR) continue;
      } else {
        const used = capacityUsed(bookings, "PS5", startMin, endMin);
        const after = used + 1;
        if(after > CONFIG.CAPACITY.PS5) continue;
      }

      all.push(startMin);
    }

    // UI: mostrar alguns e bot√£o ‚Äúmais‚Äù
    const showAll = cState.showAllSlots;
    const show = showAll ? all : all.slice(0, 8);

    if(all.length === 0){
      slotsEl.innerHTML = `<span class="pill warn"><b>Sem hor√°rios</b> ‚Ä¢ Tente outro dia</span>`;
    }

    for(const startMin of show){
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "slot";
      btn.innerHTML = `<div class="time">${minToTime(startMin)}</div><div class="meta">${duration} min ‚Ä¢ ${cState.type}</div>`;
      btn.addEventListener("click", ()=>{
        document.querySelectorAll("#c_slots button").forEach(x=>x.classList.remove("active"));
        btn.classList.add("active");
        cState.startMin = startMin;
      });
      slotsEl.appendChild(btn);
    }

    const moreBtn = $("c_moreBtn");
    if(all.length > 8 && !showAll){
      moreBtn.style.display = "";
      moreBtn.textContent = `Ver mais hor√°rios (${all.length - 8} restantes)`;
    } else if(showAll && all.length > 8){
      moreBtn.style.display = "";
      moreBtn.textContent = "Mostrar menos";
    } else {
      moreBtn.style.display = "none";
    }
  }

  async function cCreateBookingAndOpenWhatsApp(){
    const err = cValidate();
    if(err){ toast(err); return; }

    const name = $("c_name").value.trim();
    const phone = normalizePhone($("c_phone").value.trim());
    const notes = $("c_notes").value.trim();

    const startMin = cState.startMin;
    const endMin = startMin + cState.duration;
    const price = suggestedTotal(cState.type, cState.duration, cState.people);

    // montar objeto
    const booking = {
      date: cState.date,
      start_min: startMin,
      end_min: endMin,
      type: cState.type,
      qty: cState.type === "VR" ? cState.people : cState.people, // PS5: 1 ou 2 pessoas, mas ocupa 1 console
      status: "PENDENTE",
      name,
      phone,
      price: price ? Number(price) : null,
      notes,
      source: "client",
    };

    // checar capacidade novamente com dados do banco (defensivo)
    let bookings = [];
    try{
      bookings = await fetchDay(cState.date);
    }catch(e){
      toast("Configure o Supabase para ativar agenda online.");
      return;
    }
    const chk = canCreateOrUpdate(bookings, booking);
    if(!chk.ok){ toast(chk.reason); await cBuildSlots(); return; }

    // inserir
    const client = ensureSupabase();
    const { data, error } = await client.from(TABLE).insert(booking).select("*").single();
    if(error){
      toast("N√£o consegui salvar no banco. Tente novamente.");
      console.error(error);
      return;
    }

    // atualizar UI
    toast("Pedido enviado! Abrindo WhatsApp‚Ä¶");
    await cBuildSlots();

    // WhatsApp
    const msgLines = [];
    msgLines.push("MW Gamer ‚Ä¢ Pedido de agendamento");
    msgLines.push(`Nome: ${name}`);
    if(phone) msgLines.push(`WhatsApp: ${phone}`);
    msgLines.push(`Data: ${formatBR(cState.date)}`);
    msgLines.push(`Hor√°rio: ${minToTime(startMin)}‚Äì${minToTime(endMin)}`);
    if(cState.type === "VR"){
      msgLines.push(`Experi√™ncia: VR (Meta Quest 3) ‚Ä¢ Pessoas: ${cState.people}`);
    } else {
      msgLines.push(`Experi√™ncia: PS5 ‚Ä¢ Pessoas: ${cState.people} (1 console)`);
    }
    if(price) msgLines.push(`Total estimado: R$ ${price}`);
    if(notes) msgLines.push(`Obs: ${notes}`);
    msgLines.push(`C√≥digo do pedido: ${data.id}`);
    msgLines.push(CONFIG.ADDRESS_LINE);

    const url = buildWppUrlE164(CONFIG.WHATSAPP_NUMBER_E164, msgLines.join("\n"));
    window.open(url, "_blank");
  }

  function cSyncUI(){
    $("c_priceHint").innerHTML = `<span class="pill ok"><b>Pre√ßos:</b> ${cPriceHint()}</span>`;
    $("c_total").textContent = suggestedTotal(cState.type, cState.duration, cState.people) || "‚Äî";
    cRenderPeopleButtons();
    cBuildSlots();
  }

  // ==========================================================
  // ADMIN VIEW LOGIC
  // ==========================================================
  let aEditingId = null;
  let aRealtimeChannel = null;

  async function aRender(){
    const date = $("a_date").value;
    $("a_dayLabel").textContent = `Data: ${formatBR(date)}`;
    $("a_openHours").textContent = `${minToTime(CONFIG.DAY_START*60)}‚Äì${minToTime(CONFIG.DAY_END*60)}`;
    $("a_capVr").textContent = String(CONFIG.CAPACITY.VR);
    $("a_capPs5").textContent = String(CONFIG.CAPACITY.PS5);

    // avisos
    const noticeEl = $("a_dayNotice");
    if(isClosedWeekday(date)){
      noticeEl.innerHTML = `<span class="pill" style="border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.04);">
        <b>Domingo</b> ‚Ä¢ Fechado (sem agendamentos)
      </span>`;
    } else {
      noticeEl.innerHTML = `<span class="pill warn"><b>Almo√ßo</b> ‚Ä¢ 12:00‚Äì13:00 indispon√≠vel</span>
      <span class="pill ok"><b>Regras</b> ‚Ä¢ Datas passadas bloqueadas</span>`;
    }

    let bookings = [];
    try{
      bookings = await fetchDay(date);
    }catch(e){
      toast("Configure o Supabase para usar o painel.");
      console.error(e);
      return;
    }

    aRenderKpis(bookings);
  aRenderQuickPendings(bookings);
    aRenderSlots(date, bookings);
    aRenderList(date, bookings);
    aApplyViewMode();
  }

  function aApplyViewMode(){
    const mode = $("a_viewMode").value;
    $("a_slotsWrap").style.display = (mode === "SLOTS") ? "" : "none";
    $("a_listWrap").style.display = (mode === "LIST") ? "" : "none";
  }

  function aApplyFilters(bookings){
    const ft = $("a_filterType").value;
    const q = $("a_search").value.trim().toLowerCase();
    let out = bookings;

    if(ft === "PENDENTE" || ft === "PAGO"){
      out = out.filter(b => b.type !== "BLOQUEIO" && b.status === ft);
    } else if(ft !== "ALL"){
      out = out.filter(b => b.type === ft);
    }

    if(q){
      out = out.filter(b=>{
        const name = (b.name || "").toLowerCase();
        const phone = (b.phone || "").toLowerCase();
        return name.includes(q) || phone.includes(q);
      });
    }
    return out;
  }

  function aRenderKpis(bookings){
    const vr = bookings.filter(b=>b.type==="VR").reduce((acc,b)=>acc + (b.qty||0),0);
    const ps5 = bookings.filter(b=>b.type==="PS5").length;
    const blocks = bookings.filter(b=>b.type==="BLOQUEIO").length;
    const pend = bookings.filter(b=>b.status==="PENDENTE" && b.type!=="BLOQUEIO").length;
    const paid = bookings.filter(b=>b.status==="PAGO" && b.type!=="BLOQUEIO").length;

    $("a_kpis").innerHTML = `
      <span class="pill"><b>VR</b> ${vr}</span>
      <span class="pill"><b>PS5</b> ${ps5}</span>
      <span class="pill"><b>Bloqueios</b> ${blocks}</span>
      <span class="pill warn"><b>Pendente</b> ${pend}</span>
      <span class="pill ok"><b>Pago</b> ${paid}</span>
    `;
  }

function aRenderQuickPendings(bookings){
  const box = $("a_quickPend");
  if(!box) return;

  const pend = bookings
    .filter(b=>b.status==="PENDENTE" && b.type!=="BLOQUEIO")
    .sort((a,b)=>a.start_min-b.start_min);

  if(pend.length===0){
    box.innerHTML = `<div class="muted">Sem pendentes hoje üéâ</div>`;
    return;
  }

  const rows = pend.slice(0,8).map(b=>{
    const hh = minToHHMM(b.start_min);
    const type = (b.type||"VR");
    const qty = (b.qty ?? 1);
    const who = esc(b.name||"(sem nome)");
    const phone = esc(b.phone||"");
    return `
      <div class="row" style="justify-content:space-between; gap:10px; align-items:center; padding:8px 0; border-top:1px solid rgba(255,255,255,.06)">
        <div style="min-width:0">
          <div><b>${hh}</b> ‚Ä¢ ${type} ‚Ä¢ ${qty}p</div>
          <div class="muted" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${who}${phone?` ‚Ä¢ ${phone}`:""}</div>
        </div>
        <div class="row" style="gap:8px">
          <button class="ghost" type="button" data-qwpp="${b.id}">WhatsApp</button>
          <button class="primary" type="button" data-qpay="${b.id}">Pagar</button>
        </div>
      </div>`;
  }).join("");

  box.innerHTML = `
    <div><b>Pendentes (${pend.length})</b></div>
    ${rows}
    ${pend.length>8?`<div class="muted" style="margin-top:6px">+${pend.length-8} pendente(s) a mais (use o filtro "Pendentes")</div>`:""}
  `;

  box.querySelectorAll("[data-qwpp]").forEach(btn=>btn.addEventListener("click", ()=>{
    const id = btn.getAttribute("data-qwpp");
    const b = bookings.find(x=>x.id===id);
    if(!b) return;
    const msg = buildWppMsg(b, "PENDENTE");
    const e164 = phoneToE164Br(b.phone||"");
    if(!e164){ toast("Telefone inv√°lido (use DDD + n√∫mero)"); return; }
    window.open(`https://wa.me/${e164}?text=${encodeURIComponent(msg)}`,"_blank");
  }));

  box.querySelectorAll("[data-qpay]").forEach(btn=>btn.addEventListener("click", async ()=>{
    const id = btn.getAttribute("data-qpay");
    btn.disabled = true;
    try{
      await adminApi("set_status", { id, status:"PAGO" });
      toast("Marcado como PAGO");
      await aRender();
    }catch(err){
      console.error(err);
      toast("Erro ao marcar pago");
    }finally{
      btn.disabled = false;
    }
  }));
}


  function aRenderSlots(date, bookings){
    const slotsEl = $("a_slots");
    slotsEl.innerHTML = "";

    if(isClosedWeekday(date)){
      slotsEl.innerHTML = `<div class="muted" style="font-size:12px">Domingo: fechado. N√£o h√° hor√°rios dispon√≠veis.</div>`;
      return;
    }

    for(let h=CONFIG.DAY_START; h<CONFIG.DAY_END; h++){
      for(let m=0; m<60; m+=CONFIG.SLOT_MINUTES){
        const startMin = h*60 + m;
        const endMin = startMin + CONFIG.SLOT_MINUTES;
        if(inLunchBreak(startMin, endMin)) continue;

        const blocked = hasBlock(bookings, startMin, endMin);
        const usedVR = capacityUsed(bookings, "VR", startMin, endMin);
        const usedPS5 = capacityUsed(bookings, "PS5", startMin, endMin);

        const vrOk = usedVR < CONFIG.CAPACITY.VR;
        const psOk = usedPS5 < CONFIG.CAPACITY.PS5;

        const badge = blocked
          ? `<span class="badge block">BLOQUEADO</span>`
          : (vrOk || psOk)
            ? `<span class="badge ok">DISPON√çVEL</span>`
            : `<span class="badge busy">LOTADO</span>`;

        const slot = document.createElement("div");
        slot.className = "slot";
        slot.innerHTML = `
          <div class="slotTop">
            <div class="time">${minToTime(startMin)}</div>
            ${badge}
          </div>
          <div class="meta">
            VR: <b>${usedVR}/${CONFIG.CAPACITY.VR}</b> ‚Ä¢ PS5: <b>${usedPS5}/${CONFIG.CAPACITY.PS5}</b>
          </div>
          <div class="slotBtns">
            <button type="button" class="ghost small" data-new="${startMin}">Novo</button>
            <button type="button" class="ghost small" data-block="${startMin}">Bloquear</button>
          </div>
        `;
        slotsEl.appendChild(slot);
      }
    }

    slotsEl.querySelectorAll("button[data-new]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const startMin = Number(btn.dataset.new);
        aOpenModalCreate({ date, startMin, type: "VR" });
      });
    });
    slotsEl.querySelectorAll("button[data-block]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const startMin = Number(btn.dataset.block);
        aOpenModalCreate({ date, startMin, type: "BLOQUEIO" });
      });
    });
  }

  function aRenderList(date, bookings){
    const listEl = $("a_list");
    const filtered = aApplyFilters(bookings);

    if(filtered.length === 0){
      listEl.innerHTML = `<div class="muted" style="font-size:12px">Nenhum agendamento encontrado.</div>`;
      return;
    }

    listEl.innerHTML = filtered.map(b=>{
      const start = minToTime(b.start_min);
      const end = minToTime(b.end_min);

      const tag = b.type === "BLOQUEIO"
        ? `<span class="tag block">Bloqueio</span>`
        : (b.status === "PAGO"
          ? `<span class="tag paid">Pago</span>`
          : `<span class="tag pending">Pendente</span>`);

      const qtyTxt = b.type === "BLOQUEIO" ? "" : ` ‚Ä¢ Pessoas: <b>${b.qty}</b>`;
      const priceTxt = b.price ? ` ‚Ä¢ R$ <b>${String(b.price)}</b>` : "";
      const phoneTxt = b.phone ? ` ‚Ä¢ ${b.phone}` : "";
      const src = b.source ? ` ‚Ä¢ <span class="muted">origem:</span> ${b.source}` : "";

      return `
        <div class="item">
          <div class="itemMain">
            <div class="itemTitle">${start}‚Äì${end} ‚Ä¢ ${humanType(b.type)}${qtyTxt}${priceTxt}</div>
            <div class="itemSmall">
              ${tag}
              <span class="muted">Cliente/Motivo:</span> <b>${b.name || "‚Äî"}</b>${phoneTxt}${src}
              ${b.notes ? `<div class="itemSmall">Obs: ${b.notes}</div>` : ``}
            </div>
          </div>
          <div class="itemBtns">
            <button class="ghost small" data-wpp="${b.id}" type="button">WhatsApp</button>
            ${b.type==="BLOQUEIO" ? "" : `<button class="ghost small" data-pay="${b.id}" type="button">${b.status==="PAGO" ? "Pago ‚úì" : "Marcar pago"}</button>`}
            <button class="primary small" data-edit="${b.id}" type="button">Editar</button>
            <button class="danger small" data-del="${b.id}" type="button">Excluir</button>
          </div>
        </div>
      `;
    }).join("");

    listEl.querySelectorAll("button[data-wpp]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.dataset.wpp;
        const b = getCachedDay(date).find(x=>x.id===id);
        if(!b) return;
        const msg = buildWppMsg(b);
        await navigator.clipboard.writeText(msg);
        toast("Mensagem copiada para WhatsApp.");
        // opcional: abrir conversa se tiver telefone do cliente
        const e164 = phoneToE164Br(b.phone);
        if(e164){
          window.open(buildWppUrlE164(e164, msg), "_blank");
        }
      });
    });

    listEl.querySelectorAll("button[data-pay]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.dataset.pay;
        const b = getCachedDay(date).find(x=>x.id===id);
        if(!b || b.type==="BLOQUEIO") return;

        const newStatus = (b.status === "PAGO") ? "PENDENTE" : "PAGO";
        try{
          await adminApi("set_status", { id, status: newStatus });
          toast(newStatus === "PAGO" ? "Marcado como pago." : "Marcado como pendente.");
          await aRender();
        }catch(e){
          console.error(e);
          toast(e.message || "Erro ao atualizar status.");
        }
      });
    });

    listEl.querySelectorAll("button[data-edit]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.dataset.edit;
        const b = getCachedDay(date).find(x=>x.id===id);
        if(!b) return;
        aOpenModalEdit(b);
      });
    });

    listEl.querySelectorAll("button[data-del]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.dataset.del;
        const b = getCachedDay(date).find(x=>x.id===id);
        if(!b) return;
        if(confirm(`Excluir agendamento de "${b.name || "‚Äî"}" (${minToTime(b.start_min)}‚Äì${minToTime(b.end_min)})?`)){
          try{
            await adminApi("delete", { id });
            toast("Agendamento exclu√≠do.");
            await aRender();
          }catch(e){
            console.error(e);
            toast(e.message || "Erro ao excluir.");
          }
        }
      });
    });
  }

  // ==============================
  // ADMIN MODAL
  // ==============================
  function openModal(){ $("modalOverlay").style.display = "flex"; }
  function closeModal(){ $("modalOverlay").style.display = "none"; aEditingId = null; }

  function setQtyOptionsForType(selectEl, type){
    if(type === "VR"){
      selectEl.innerHTML = [1,2,3,4,5,6].map(n=>`<option value="${n}" ${n===6?"selected":""}>${n}</option>`).join("");
    } else if(type === "PS5"){
      selectEl.innerHTML = [1,2].map(n=>`<option value="${n}" ${n===1?"selected":""}>${n}</option>`).join("");
    } else {
      selectEl.innerHTML = `<option value="0" selected>‚Äî</option>`;
    }
  }

  function updateModalQtyOptions(){
    const type = $("m_type").value;
    setQtyOptionsForType($("m_qty"), type);

    $("m_name").placeholder = (type === "BLOQUEIO")
      ? "Motivo do bloqueio (ex: manuten√ß√£o)"
      : "Ex: Jo√£o";

    $("m_status").disabled = (type === "BLOQUEIO");
    if(type === "BLOQUEIO") $("m_status").value = "PENDENTE";
  }

  function refreshModalKpis(bookings, ignoreId=null){
    const startMin = timeToMin($("m_start").value);
    const endMin = startMin + Number($("m_duration").value);
    const blocked = hasBlock(bookings, startMin, endMin, ignoreId);
    const usedVR = capacityUsed(bookings, "VR", startMin, endMin, ignoreId);
    const usedPS5 = capacityUsed(bookings, "PS5", startMin, endMin, ignoreId);

    $("modalKpis").innerHTML = `
      <span class="pill"><b>VR</b> ${usedVR}/${CONFIG.CAPACITY.VR}</span>
      <span class="pill"><b>PS5</b> ${usedPS5}/${CONFIG.CAPACITY.PS5}</span>
      <span class="pill"><b>Status</b> ${blocked ? "Bloqueado" : "OK"}</span>
    `;
  }

  function aOpenModalCreate({date, startMin, type}){
    if(isPastDate(date)){ toast("Data anterior bloqueada."); return; }
    if(isClosedWeekday(date)){ toast("Domingo √© fechado."); return; }
    if(inLunchBreak(startMin, startMin + 30)){ toast("Hor√°rio de almo√ßo (12:00‚Äì13:00)."); return; }

    aEditingId = null;
    $("modalTitle").textContent = "Novo agendamento";
    $("modalSubtitle").textContent = `Data ${formatBR(date)} ‚Ä¢ In√≠cio ${minToTime(startMin)}`;
    $("deleteBtn").style.display = "none";

    $("m_date").value = date;
    $("m_start").value = minToTime(startMin);
    $("m_duration").value = "30";
    $("m_type").value = type || "VR";

    updateModalQtyOptions();

    $("m_status").value = "PENDENTE";
    $("markPaidBtn").style.display = "none";
    $("m_name").value = "";
    $("m_phone").value = "";
    $("m_price").value = "";
    $("m_notes").value = "";

    // auto price
    const qty = Number($("m_qty").value || "0");
    const sug = suggestedTotal($("m_type").value, Number($("m_duration").value), qty);
    if(sug) $("m_price").value = sug;

    const bookings = getCachedDay(date);
    refreshModalKpis(bookings, null);
    openModal();
  }

  function aOpenModalEdit(b){
    aEditingId = b.id;
    $("modalTitle").textContent = "Editar agendamento";
    $("modalSubtitle").textContent = `${formatBR(b.date)} ‚Ä¢ ${minToTime(b.start_min)}‚Äì${minToTime(b.end_min)}`;
    $("deleteBtn").style.display = "";

    $("m_date").value = b.date;
    $("m_start").value = minToTime(b.start_min);
    $("m_duration").value = String(b.end_min - b.start_min);
    $("m_type").value = b.type;

    updateModalQtyOptions();
    $("m_qty").value = String(b.qty || 0);

    $("m_status").value = b.status || "PENDENTE";
    $("markPaidBtn").style.display = (($("m_status").value)==="PENDENTE" ? "" : "none");
    $("m_name").value = b.name || "";
    $("m_phone").value = b.phone || "";
    $("m_price").value = b.price || "";
    $("m_notes").value = b.notes || "";

    const bookings = getCachedDay(b.date);
    refreshModalKpis(bookings, b.id);
    openModal();
  }

  function gatherModalBooking(){
    const date = $("m_date").value;
    const startMin = timeToMin($("m_start").value);
    const duration = Number($("m_duration").value);
    const endMin = startMin + duration;

    const type = $("m_type").value;
    const qty = Number($("m_qty").value || "0");
    const status = $("m_status").value;

    const name = $("m_name").value.trim();
    const phone = normalizePhone($("m_phone").value.trim());
    const price = parsePrice($("m_price").value.trim());
    const notes = $("m_notes").value.trim();

    return {
      id: aEditingId || undefined,
      date,
      start_min: startMin,
      end_min: endMin,
      type,
      qty: type === "BLOQUEIO" ? 0 : qty,
      status: type === "BLOQUEIO" ? "PENDENTE" : status,
      name: name || "",
      phone: phone || "",
      price: price ? Number(price) : null,
      notes: notes || "",
      source: "admin",
    };
  }

  function validateBooking(b){
    if(!b.date) return "Selecione a data.";
    if(isPastDate(b.date)) return "N√£o √© poss√≠vel agendar em dias anteriores ao dia atual.";
    if(isClosedWeekday(b.date)) return "Domingo: a MW Gamer est√° fechada.";

    if(b.start_min < CONFIG.DAY_START*60 || b.start_min >= CONFIG.DAY_END*60) return "Hor√°rio fora do funcionamento.";
    if(b.end_min > CONFIG.DAY_END*60) return "Dura√ß√£o ultrapassa o hor√°rio de funcionamento.";
    if(b.end_min <= b.start_min) return "Hor√°rio inv√°lido.";
    if(inLunchBreak(b.start_min, b.end_min)) return "Hor√°rio indispon√≠vel (intervalo de almo√ßo: 12:00‚Äì13:00).";

    if(b.type !== "BLOQUEIO"){
      if(!b.name) return "Informe o nome do cliente.";
      if(b.type === "PS5" && !(b.qty === 1 || b.qty === 2)) return "PS5 aceita apenas 1 ou 2 pessoas.";
      if(b.type === "VR" && (b.qty < 1 || b.qty > 6)) return "VR aceita 1 a 6 pessoas.";
    } else {
      if(!b.name) return "Informe o motivo do bloqueio.";
    }
    return null;
  }

  async function copyModalWhatsApp(){
    const b = gatherModalBooking();
    const msg = buildWppMsg(b);
    await navigator.clipboard.writeText(msg);
    toast("Mensagem copiada (modelo).");
  }

  async function openModalWhatsApp(){
    const b = gatherModalBooking();
    const msg = buildWppMsg(b);
    const e164 = phoneToE164Br(b.phone);
    if(!e164){
      toast("Sem WhatsApp do cliente para abrir. Copiei a mensagem.");
      await navigator.clipboard.writeText(msg);
      return;
    }
    window.open(buildWppUrlE164(e164, msg), "_blank");
  }

  async function saveModal(){
    const b = gatherModalBooking();
    const err = validateBooking(b);
    if(err) return toast(err);

    // checar capacidade com cache (refor√ßar com fetch)
    let bookings = [];
    try{
      bookings = await fetchDay(b.date);
    }catch(e){
      toast("Configure o Supabase para usar o painel.");
      return;
    }
    const chk = canCreateOrUpdate(bookings, b);
    if(!chk.ok) return toast(chk.reason);

    try{
      // Usa Edge Function (service role no backend) para upsert
      await adminApi("upsert", { booking: b });

      closeModal();
      $("a_date").value = b.date;
      toast("Salvo com sucesso.");
      await aRender();
    }catch(e){
      console.error(e);
      toast(e.message || "Erro ao salvar.");
    }
  }

  async function deleteModal(){
    if(!aEditingId) return;
    if(!confirm("Excluir este agendamento?")) return;

    try{
      await adminApi("delete", { id: aEditingId });
      closeModal();
      toast("Exclu√≠do.");
      await aRender();
    }catch(e){
      console.error(e);
      toast(e.message || "Erro ao excluir.");
    }
  }

  async function resetAll(){
    if(!confirm("Apagar TODOS os agendamentos do banco? (irrevers√≠vel)")) return;
    try{
      await adminApi("reset_all", {});
      toast("Dados zerados.");
      await aRender();
    }catch(e){
      console.error(e);
      toast(e.message || "Erro ao zerar.");
    }
  }

  function downloadDayCsv(){
    const date = $("a_date").value;
    const bookings = getCachedDay(date);
    const rows = [];
    rows.push(["Data","In√≠cio","Fim","Tipo","Pessoas","Status","Nome/Motivo","WhatsApp","Valor","Obs"].join(";"));

    for(const b of bookings){
      const start = minToTime(b.start_min);
      const end = minToTime(b.end_min);
      const people = (b.type === "BLOQUEIO") ? "" : String(b.qty || "");
      const status = (b.type === "BLOQUEIO") ? "" : (b.status || "");
      const line = [
        formatBR(b.date),
        start,
        end,
        humanType(b.type),
        people,
        status,
        (b.name || ""),
        (b.phone || ""),
        (b.price ? ("R$ " + b.price) : ""),
        (b.notes || "")
      ].map(v => `"${String(v).replace(/"/g,'""')}"`).join(";");
      rows.push(line);
    }

    const csv = rows.join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `mw_gamer_agenda_${date}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
    toast("CSV baixado.");
  }

  async function copyWppPreview(){
    const date = $("a_date").value;
    const preview = {
      date,
      start_min: CONFIG.DAY_START*60,
      end_min: CONFIG.DAY_START*60 + 30,
      type: "VR",
      qty: 2,
      name: "Cliente",
      phone: "",
      price: Number(suggestedTotal("VR", 30, 2)),
      status: "PENDENTE",
      notes: "Exemplo"
    };
    await navigator.clipboard.writeText(buildWppMsg(preview));
    toast("Mensagem (modelo) copiada.");
  }

  // ==========================================================
  // REALTIME NOTIFICATIONS (ADMIN)
  // ==========================================================
  function startRealtimeForAdmin(){
    // evita duplicar
    if(aRealtimeChannel) return;

    try{
      const client = ensureSupabase();
      aRealtimeChannel = client.channel("mw_bookings_realtime")
        .on("postgres_changes", { event: "INSERT", schema: "public", table: TABLE }, payload => {
          const rec = payload.new;
          // s√≥ notificar se for ‚Äúclient‚Äù e pendente, para n√£o poluir
          if(rec && rec.source === "client"){
            toast(`Novo pedido: ${rec.name || "Cliente"} ‚Ä¢ ${formatBR(rec.date)} ${minToTime(rec.start_min)}`);
            // atualizar tela se estiver no mesmo dia
            const current = $("a_date")?.value;
            if(current && current === rec.date){
              aRender();
            }
          }
        })
        .on("postgres_changes", { event: "UPDATE", schema: "public", table: TABLE }, payload => {
          const rec = payload.new;
          const current = $("a_date")?.value;
          if(current && rec && current === rec.date){
            aRender();
          }
        })
        .on("postgres_changes", { event: "DELETE", schema: "public", table: TABLE }, payload => {
          const current = $("a_date")?.value;
          if(current){
            aRender();
          }
        })
        .subscribe();
    }catch(e){
      // supabase n√£o configurado
    }
  }

  function stopRealtime(){
    if(!aRealtimeChannel) return;
    try{
      const client = ensureSupabase();
      client.removeChannel(aRealtimeChannel);
    }catch(e){}
    aRealtimeChannel = null;
  }

  // ==========================================================
  // BIND UI
  // ==========================================================
  function bindRouter(){
    $("goClientBtn").addEventListener("click", ()=> goto("cliente"));
    $("goAdminBtn").addEventListener("click", ()=> goto("admin"));
    window.addEventListener("hashchange", onRoute);
  }

  async function onRoute(){
    const mode = currentMode();
    if(mode === "admin"){
      setMode("admin");
      // lock?
      if(!isUnlocked()){
        $("lockOverlay").style.display = "flex";
        $("adminView").classList.add("appHidden");
      } else {
        unlockAdmin();
      }
      // render admin
      try{ ensureSupabase(); } catch(e){ /* ok */ }
      startRealtimeForAdmin();
      await aRender();
    } else {
      setMode("cliente");
      stopRealtime();
      await cBuildSlots();
    }
  }

  function bindLock(){
    const pinInput = $("pinInput");
    const unlockBtn = $("unlockBtn");
    const openClientFromLockBtn = $("openClientFromLockBtn");
    const logoutBtn = $("logoutBtn");

    function tryUnlock(){
      const v = (pinInput?.value || "").trim();
      const pass = ($("adminPassInput")?.value || "").trim();

      if(v !== ADMIN_PIN){
        toast("PIN incorreto.");
        return;
      }
      if(!pass){
        toast("Digite a Senha Admin.");
        return;
      }

      adminPass = pass;
      sessionStorage.setItem(ADMIN_PASS_SESSION_KEY, adminPass);

      unlockAdmin();
      if(pinInput) pinInput.value = "";
      const ap = $("adminPassInput"); if(ap) ap.value = "";
      toast("Bem-vindo ao painel.");
      startRealtimeForAdmin();
      aRender();
    }

    unlockBtn?.addEventListener("click", tryUnlock);
    pinInput?.addEventListener("keydown", (e)=>{ if(e.key === "Enter") tryUnlock(); });

    openClientFromLockBtn?.addEventListener("click", ()=> goto("cliente"));

    logoutBtn?.addEventListener("click", ()=>{
      lockAdmin();
      toast("Sess√£o encerrada.");
    });
  }

  function bindClient(){
    $("c_btnVR").addEventListener("click", ()=>{
      cState.type = "VR";
      if(cState.people > 6) cState.people = 2;
      cSetActive([$("c_btnVR"),$("c_btnPS5")], "c_btnVR");
      cSyncUI();
    });
    $("c_btnPS5").addEventListener("click", ()=>{
      cState.type = "PS5";
      if(cState.people > 2) cState.people = 1;
      cSetActive([$("c_btnVR"),$("c_btnPS5")], "c_btnPS5");
      cSyncUI();
    });

    $("c_btn30").addEventListener("click", ()=>{
      cState.duration = 30;
      cState.showAllSlots = false;
      cState.startMin = null;
      cSetActive([$("c_btn30"),$("c_btn60")], "c_btn30");
      cSyncUI();
      $("c_slots").scrollIntoView({behavior:"smooth", block:"start"});
    });
    $("c_btn60").addEventListener("click", ()=>{
      cState.duration = 60;
      cState.showAllSlots = false;
      cState.startMin = null;
      cSetActive([$("c_btn30"),$("c_btn60")], "c_btn60");
      cSyncUI();
      $("c_slots").scrollIntoView({behavior:"smooth", block:"start"});
    });

    $("c_date").addEventListener("change", async ()=>{
      const v = $("c_date").value;
      if(isPastDate(v)){
        $("c_date").value = todayISO();
        cState.date = $("c_date").value;
        toast("Data anterior bloqueada. Selecione hoje ou uma data futura.");
      } else {
        cState.date = v;
      }
      if(isClosedWeekday(cState.date)){
        const dd = new Date(cState.date + "T00:00:00");
        dd.setDate(dd.getDate()+1);
        $("c_date").value = dd.toISOString().slice(0,10);
        cState.date = $("c_date").value;
        toast("Domingo √© fechado. Ajustei para a pr√≥xima segunda-feira.");
      }
      cState.showAllSlots = false;
      cState.startMin = null;
      await cBuildSlots();
    });

    $("c_phone").addEventListener("input", ()=>{ $("c_phone").value = normalizePhone($("c_phone").value); });

    $("c_moreBtn").addEventListener("click", async ()=>{
      cState.showAllSlots = !cState.showAllSlots;
      await cBuildSlots();
    });

    $("c_sendBtn").addEventListener("click", cCreateBookingAndOpenWhatsApp);
  }

  function bindAdmin(){
    $("a_date").addEventListener("change", async ()=>{
      const d = $("a_date").value;
      if(isPastDate(d)){
        $("a_date").value = todayISO();
        toast("Data anterior bloqueada.");
      } else if(isClosedWeekday(d)){
        const dd = new Date(d + "T00:00:00");
        dd.setDate(dd.getDate()+1);
        $("a_date").value = dd.toISOString().slice(0,10);
        toast("Domingo √© fechado. Ajustei para a pr√≥xima segunda-feira.");
      }
      await aRender();
    });

    $("a_filterType").addEventListener("change", ()=>{ aRenderList($("a_date").value, getCachedDay($("a_date").value)); aApplyViewMode(); });
    $("a_search").addEventListener("input", ()=>{ aRenderList($("a_date").value, getCachedDay($("a_date").value)); aApplyViewMode(); });
    $("a_viewMode").addEventListener("change", ()=> aApplyViewMode());

    $("a_prevDayBtn").addEventListener("click", ()=>{
      const d = new Date($("a_date").value + "T00:00:00");
      d.setDate(d.getDate()-1);
      const iso = d.toISOString().slice(0,10);
      if(isPastDate(iso)) return toast("Dias anteriores ao atual est√£o bloqueados.");
      $("a_date").value = iso;
      $("a_date").dispatchEvent(new Event("change"));
    });

    $("a_nextDayBtn").addEventListener("click", ()=>{
      const d = new Date($("a_date").value + "T00:00:00");
      d.setDate(d.getDate()+1);
      $("a_date").value = d.toISOString().slice(0,10);
      $("a_date").dispatchEvent(new Event("change"));
    });

    $("a_newBtn").addEventListener("click", ()=>{
      const date = $("a_date").value;
      aOpenModalCreate({ date, startMin: timeToMin("10:00"), type: "VR" });
    });

    $("a_downloadCsvBtn").addEventListener("click", downloadDayCsv);
    $("a_copyWppPreviewBtn").addEventListener("click", copyWppPreview);
    $("a_resetBtn").addEventListener("click", resetAll);

    // modal
    $("closeModalBtn").addEventListener("click", closeModal);
    $("modalOverlay").addEventListener("click", (e)=>{ if(e.target === $("modalOverlay")) closeModal(); });

    $("m_type").addEventListener("change", ()=>{
      updateModalQtyOptions();
      const qty = Number($("m_qty").value || "0");
      const sug = suggestedTotal($("m_type").value, Number($("m_duration").value), qty);
      if(sug) $("m_price").value = sug;
      refreshModalKpis(getCachedDay($("m_date").value), aEditingId);
    });

    ["m_date","m_start","m_duration"].forEach(id=>{
      $(id).addEventListener("change", ()=>{
        if(id === "m_date"){
          const d = $("m_date").value;
          if(isPastDate(d)){
            $("m_date").value = todayISO();
            toast("Data anterior bloqueada.");
          } else if(isClosedWeekday(d)){
            const dd = new Date(d + "T00:00:00");
            dd.setDate(dd.getDate()+1);
            $("m_date").value = dd.toISOString().slice(0,10);
            toast("Domingo √© fechado. Ajustei para a pr√≥xima segunda-feira.");
          }
        }
        const qty = Number($("m_qty").value || "0");
        const sug = suggestedTotal($("m_type").value, Number($("m_duration").value), qty);
        if(sug) $("m_price").value = sug;
        refreshModalKpis(getCachedDay($("m_date").value), aEditingId);
      });
    });

    $("m_qty").addEventListener("change", ()=>{
      const qty = Number($("m_qty").value || "0");
      const sug = suggestedTotal($("m_type").value, Number($("m_duration").value), qty);
      if(sug) $("m_price").value = sug;
      refreshModalKpis(getCachedDay($("m_date").value), aEditingId);
    });

    $("m_phone").addEventListener("input", ()=>{ $("m_phone").value = normalizePhone($("m_phone").value); });
    $("m_price").addEventListener("input", ()=>{ $("m_price").value = parsePrice($("m_price").value); });

    $("copyWppBtn").addEventListener("click", copyModalWhatsApp);
    $("openWppBtn").addEventListener("click", openModalWhatsApp);
$("markPaidBtn").addEventListener("click", ()=>{ $("m_status").value="PAGO"; saveModal(); });
    $("saveBtn").addEventListener("click", saveModal);
    $("deleteBtn").addEventListener("click", deleteModal);
  }

  // ==========================================================
  // START
  // ==========================================================
  document.addEventListener("DOMContentLoaded", async ()=>{
    // defaults date
    const today = todayISO();

    // client
    $("c_date").min = today;
    $("c_date").value = today;
    cState.date = $("c_date").value;
    if(isClosedWeekday(cState.date)){
      const d = new Date(today + "T00:00:00");
      d.setDate(d.getDate()+1);
      $("c_date").value = d.toISOString().slice(0,10);
      cState.date = $("c_date").value;
    }
    cState.people = 1;
    cState.showAllSlots = true;
    cSyncUI();

    // admin
    $("a_date").min = today;
    $("a_date").value = today;
    if(isClosedWeekday(today)){
      const d = new Date(today + "T00:00:00");
      d.setDate(d.getDate()+1);
      $("a_date").value = d.toISOString().slice(0,10);
    }

    // modal date mins
    $("m_date").min = today;

    // bind
    bindRouter();
    bindLock();
    bindClient();
    bindAdmin();

    // ensure modal qty options
    setQtyOptionsForType($("m_qty"), "VR");
    updateModalQtyOptions();

    // route now
    if(!location.hash) location.hash = "#cliente";
    await onRoute();
  });

})();
</script>

<!--
=====================================================================
INSTRU√á√ïES R√ÅPIDAS (SUPABASE) ‚Äì PARA FUNCIONAR ONLINE
=====================================================================

1) Crie um projeto no Supabase
2) Crie uma tabela chamada: mw_bookings
   Campos sugeridos (SQL):

create table if not exists public.mw_bookings (
  id uuid primary key default gen_random_uuid(),
  created_at timestamptz not null default now(),
  date date not null,
  start_min int not null,
  end_min int not null,
  type text not null,
  qty int not null default 0,
  status text not null default 'PENDENTE',
  name text,
  phone text,
  price int,
  notes text,
  source text default 'client',
  admin_confirmed_at timestamptz
);

create index if not exists mw_bookings_date_idx on public.mw_bookings(date);
create index if not exists mw_bookings_status_idx on public.mw_bookings(status);
create index if not exists mw_bookings_date_start_idx on public.mw_bookings(date, start_min);

3) Ative Realtime (Database -> Replication) para a tabela mw_bookings (INSERT/UPDATE/DELETE)

4) (Recomendado) RLS:
   - Para testes r√°pidos, voc√™ pode desativar RLS (N√ÉO recomendado em produ√ß√£o)
   - Ideal: criar policies:
     a) Allow insert for anon (para cliente criar pedido)
     b) Allow select for anon (para cliente ver disponibilidade)
     c) Allow update/delete apenas para admin (ex: usando service role em backend)

   Como este √© 1 arquivo est√°tico, ele n√£o tem como ‚Äúprovar‚Äù que voc√™ √© admin de verdade.
   Ent√£o, para produ√ß√£o s√©ria, o correto √©:
   - colocar a confirma√ß√£o "PAGO" num endpoint seu (Netlify/Supabase Edge Function)
   - e o painel admin chamar esse endpoint (com senha/secret).

=====================================================================
-->
</body>
</html>
